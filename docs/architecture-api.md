# Backend Architecture (api/)

## Overview

The backend is a Go REST API that provides authentication services compatible with better-auth. It uses PostgreSQL for persistence with type-safe queries generated by sqlc.

## Technology Stack

| Category | Technology | Version |
|----------|------------|---------|
| Language | Go | 1.24.0 |
| HTTP Server | net/http | stdlib |
| Database Driver | pgx | 5.8.0 |
| Code Generation | sqlc | latest |
| Migrations | golang-migrate | latest |
| Password Hashing | bcrypt | golang.org/x/crypto |
| Dev Server | Air | latest |

## Directory Structure

```
api/
├── main.go                  # Entry point (placeholder)
├── cmd/
│   ├── server/
│   │   └── main.go          # Server entry point
│   └── docs/
│       ├── main.go          # Documentation generator
│       ├── discovery.go     # File discovery
│       ├── generators.go    # Doc generators
│       ├── parser.go        # Go parser
│       ├── types.go         # Type definitions
│       └── utils.go         # Utilities
├── internal/
│   ├── config/
│   │   └── config.go        # Configuration loading
│   ├── handlers/
│   │   └── utils.go         # Handler utilities
│   ├── repository/
│   │   ├── db.go            # DBTX interface
│   │   ├── models.go        # Generated models
│   │   ├── sessions.sql.go  # Generated session queries
│   │   └── users.sql.go     # Generated user queries
│   ├── server/
│   │   └── main.go          # HTTP server & handlers
│   └── utils/
│       └── date_parser.go   # Date parsing utilities
├── pkg/
│   ├── auth/
│   │   └── auth.go          # Auth package (WIP)
│   ├── database/
│   │   ├── adapter.go       # Database adapter interface
│   │   └── main.go          # Database initialization
│   ├── oauth/
│   │   └── provider.go      # OAuth provider (WIP)
│   └── session/
│       └── session.go       # Session manager (WIP)
├── db/
│   ├── migrations/
│   │   ├── 000001_init_auth.up.sql
│   │   └── 000001_init_auth.down.sql
│   └── queries/
│       ├── users.sql        # User queries
│       └── sessions.sql     # Session queries
├── sqlc.yml                 # sqlc configuration
├── go.mod                   # Go modules
├── go.sum                   # Dependency checksums
├── Dockerfile               # Container build
└── .air.toml                # Air hot reload config
```

## Architecture Pattern

The backend follows Go's standard project layout:

- **cmd/**: Entry points for executables
- **internal/**: Private application code
- **pkg/**: Public libraries (reusable packages)
- **db/**: Database migrations and queries

## Key Components

### Server Entry Point (cmd/server/main.go)

```go
func main() {
    cfg, err := config.Load()
    if err != nil || cfg == nil {
        log.Fatalf("Failed to load config: %v", err)
    }
    srv := server.New(*cfg)
    if err := srv.Start(); err != nil && err != http.ErrServerClosed {
        log.Fatalf("Server error: %v", err)
    }
}
```

### HTTP Server (internal/server/main.go)

The server implements better-auth compatible endpoints:

```go
func (s *Server) Start() error {
    mux := http.NewServeMux()

    // Auth endpoints
    mux.HandleFunc("/api/auth/sign-up/email", handleSignUp)
    mux.HandleFunc("/api/auth/sign-in/email", handleSignIn)
    mux.HandleFunc("/api/auth/get-session", handleGetSession)
    mux.HandleFunc("/api/auth/sign-out", handleSignOut)

    // Health check
    mux.HandleFunc("/health", healthHandler)

    handler := corsMiddleware(mux)
    return http.ListenAndServe(":8080", handler)
}
```

### Configuration (internal/config/config.go)

```go
type Config struct {
    Environment string
    Encryption  EncryptionConfig
}

func Load() (*Config, error) {
    config := setDefaults()
    loadFromFile(configPath, config)  // Optional
    loadFromEnv(config)               // Environment overrides
    validate(config)                  // Validation
    return config, nil
}
```

### Database Adapter (pkg/database/adapter.go)

Interface for database operations:

```go
type Adapter interface {
    // User operations
    CreateUser(ctx context.Context, user *repository.User) error
    GetUserByID(ctx context.Context, id string) (*repository.User, error)
    GetUserByEmail(ctx context.Context, email string) (*repository.User, error)
    UpdateUser(ctx context.Context, id string, updates map[string]any) error
    DeleteUser(ctx context.Context, id string) error

    // Session operations
    CreateSession(ctx context.Context, session *repository.Session) error
    GetSession(ctx context.Context, token string) (*repository.Session, error)
    UpdateSession(ctx context.Context, token string, updates map[string]any) error
    DeleteSession(ctx context.Context, token string) error
    DeleteUserSessions(ctx context.Context, userID string) error
}
```

### sqlc Configuration (sqlc.yml)

```yaml
version: "2"
plugins:
  sql:
    - engine: "postgresql"
      schema: "./db/migrations"
      queries: "./db/queries"
      gen:
        go:
          emit_json_tags: true
          package: "repository"
          out: "internal/repository"
          sql_package: "pgx/v5"
          emit_pointers_for_null_types: true
```

## Build & Deployment

### Development

```bash
# With Air (hot reload)
air

# Manual
go run cmd/server/main.go
```

### Production Build

```bash
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -mod=readonly -v -o server ./cmd/server
```

### Docker

Multi-stage build:

1. **Staging**: Base golang image
2. **Development**: Add sqlc, golang-migrate, air
3. **Builder**: Compile static binary
4. **Production**: Alpine with just the binary

```dockerfile
FROM alpine:3 AS production
COPY --from=builder /app/server /server
ENTRYPOINT ["/server", "serve", "--http=0.0.0.0:8080"]
```

## Environment Variables

| Variable | Description |
|----------|-------------|
| `ENVIRONMENT` | Runtime environment (dev/prod) |
| `ENCRYPTION_KEY` | 256-bit encryption key (base64) |
| `CONFIG_FILE` | Optional JSON config file path |
| `DATABASE_URL` | PostgreSQL connection string |
| `BETTER_AUTH_SECRET` | better-auth secret key |
| `BETTER_AUTH_URL` | better-auth base URL |

## Authentication Flow

1. **Sign Up**: Create user with hashed password, create session
2. **Sign In**: Verify credentials, create session, set cookie
3. **Get Session**: Validate cookie, return user data
4. **Sign Out**: Delete session, clear cookie

### Session Cookie

```go
http.SetCookie(w, &http.Cookie{
    Name:     "better-auth.session_token",
    Value:    token,
    Path:     "/",
    MaxAge:   7 * 24 * 60 * 60,  // 7 days
    HttpOnly: true,
    SameSite: http.SameSiteLaxMode,
})
```
